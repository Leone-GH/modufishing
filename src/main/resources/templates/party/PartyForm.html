<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>파티 생성</title>
  <style>
    /* 모달 스타일 */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 10px;
      display: flex; gap: 20px;
    }
    .route-card {
      padding: 20px; border: 1px solid #ccc;
      border-radius: 10px; cursor: pointer; width: 150px;
      text-align: center;
    }
    .route-card:hover {
      background-color: #f0f0f0;
    }
    .map-context-menu {
      position: absolute; background: white; border: 1px solid #ccc;
      display: none; z-index: 9999; padding: 10px;
    }
    .map-context-menu button { display: block; margin-bottom: 5px; width: 100%; }
  </style>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0b84a2179b2534016530526202844771&libraries=services"></script>
</head>
<body>

<h1>파티 생성</h1>

<form th:action="@{/party/create}" method="post">
  <input type="text" name="title" placeholder="제목" required><br>

  <input type="text" id="departurePoint" name="departurePoint" readonly placeholder="출발지"><br>
  <input type="hidden" id="departureLat" name="departureLat">
  <input type="hidden" id="departureLng" name="departureLng">

  <input type="text" id="destination" name="destination" readonly placeholder="목적지"><br>
  <input type="hidden" id="destinationLat" name="destinationLat">
  <input type="hidden" id="destinationLng" name="destinationLng">

  <input type="datetime-local" name="departureTime" required><br>

  <input type="number" id="expectedDuration" name="expectedDuration" readonly placeholder="예상 소요 시간(분)"><br>
  <input type="number" id="estimatedCost" name="estimatedCost" readonly placeholder="예상 비용(원)"><br>

  <div id="map" style="width:100%;height:400px;margin-top:10px;"></div>

  <div id="waypointsContainer"></div>

  <button type="submit">등록하기</button>
</form>

<!-- 모달 -->
<div id="routeModal" class="modal">
  <div class="modal-content" id="modalContent"></div>
</div>

<!-- 지도 우클릭 메뉴 -->
<div id="mapContextMenu" class="map-context-menu">
  <button onclick="setLocation('departure')">출발지로 설정</button>
  <button onclick="setLocation('destination')">목적지로 설정</button>
  <button onclick="setLocation('waypoint')">경유지 추가</button>
</div>

<script>
  let map, geocoder;
  let departureMarker = null;
  let destinationMarker = null;
  let waypointMarkers = [];
  let contextMenuLatLng = null;
  let polyline = null;

  kakao.maps.load(() => {
    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.5665, 126.9780), level: 5
    });

    geocoder = new kakao.maps.services.Geocoder();
    const contextMenu = document.getElementById('mapContextMenu');

    kakao.maps.event.addListener(map, 'rightclick', function(mouseEvent) {
      contextMenuLatLng = mouseEvent.latLng;
      contextMenu.style.left = mouseEvent.point.x + 'px';
      contextMenu.style.top = mouseEvent.point.y + 'px';
      contextMenu.style.display = 'block';
    });

    kakao.maps.event.addListener(map, 'click', function() {
      contextMenu.style.display = 'none';
    });
  });

  function setLocation(type) {
    if (!contextMenuLatLng) return;

    if (type === 'departure') {
      if (departureMarker) departureMarker.setMap(null);
      departureMarker = createMarker(contextMenuLatLng);
      saveLocation('departure', contextMenuLatLng);
    } else if (type === 'destination') {
      if (destinationMarker) destinationMarker.setMap(null);
      destinationMarker = createMarker(contextMenuLatLng);
      saveLocation('destination', contextMenuLatLng);
    } else if (type === 'waypoint') {
      if (waypointMarkers.length >= 5) {
        alert('경유지는 최대 5개까지만 가능합니다.');
        return;
      }
      const marker = createMarker(contextMenuLatLng);
      waypointMarkers.push(marker);
      syncWaypoints();
    }

    document.getElementById('mapContextMenu').style.display = 'none';

    if (departureMarker && destinationMarker) {
      openRouteModal();
    }
  }

  function createMarker(latlng) {
    const marker = new kakao.maps.Marker({
      map: map,
      position: latlng
    });
    kakao.maps.event.addListener(marker, 'click', () => {
      if (confirm('이 마커를 삭제할까요?')) {
        marker.setMap(null);
        if (marker === departureMarker) departureMarker = null;
        if (marker === destinationMarker) destinationMarker = null;
        waypointMarkers = waypointMarkers.filter(m => m !== marker);
        syncWaypoints();
      }
    });
    return marker;
  }

  function saveLocation(role, latlng) {
    geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
      if (status === kakao.maps.services.Status.OK) {
        if (role === 'departure') {
          document.getElementById('departurePoint').value = result[0].address.address_name;
          document.getElementById('departureLat').value = latlng.getLat();
          document.getElementById('departureLng').value = latlng.getLng();
        } else if (role === 'destination') {
          document.getElementById('destination').value = result[0].address.address_name;
          document.getElementById('destinationLat').value = latlng.getLat();
          document.getElementById('destinationLng').value = latlng.getLng();
        }
      }
    });
  }

  function syncWaypoints() {
    const container = document.getElementById('waypointsContainer');
    container.innerHTML = '';
    waypointMarkers.forEach((marker, idx) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = `waypoints[${idx}]`;
      input.value = marker.getPosition().getLat() + ',' + marker.getPosition().getLng();
      container.appendChild(input);
    });
  }

  function openRouteModal() {
    fetchRouteOptions();
  }

  function fetchRouteOptions() {
    const origin = `${departureMarker.getPosition().getLng()},${departureMarker.getPosition().getLat()}`;
    const destination = `${destinationMarker.getPosition().getLng()},${destinationMarker.getPosition().getLat()}`;

    fetch(`https://apis-navi.kakaomobility.com/v1/directions?origin=${origin}&destination=${destination}&priority=RECOMMEND&summary=true`, {
      headers: {
        'Authorization': 'KakaoAK 2aed1eb5d8cab77b823ded86af7bc51d',
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.routes) {
        showRouteOptions(data.routes);
      }
    })
    .catch(err => console.error(err));
  }

  function showRouteOptions(routes) {
    const modal = document.getElementById('routeModal');
    const content = document.getElementById('modalContent');
    content.innerHTML = '';

    routes.forEach((route, idx) => {
      const card = document.createElement('div');
      card.className = 'route-card';
      card.innerHTML = `
        <h3>${idx === 0 ? '추천 경로' : '다른 경로'}</h3>
        <p>예상 시간: ${Math.round(route.summary.duration/60)}분</p>
        <p>예상 비용: ${route.summary.fare.taxi}원</p>
      `;
      card.onclick = () => {
        selectRoute(route);
        modal.style.display = 'none';
      };
      content.appendChild(card);
    });

    modal.style.display = 'flex';
  }

  function selectRoute(route) {
    if (polyline) polyline.setMap(null);

    const path = [];
    route.sections.forEach(section => {
      section.roads.forEach(road => {
        for (let i = 0; i < road.vertexes.length; i += 2) {
          path.push(new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]));
        }
      });
    });

    polyline = new kakao.maps.Polyline({
      map: map,
      path: path,
      strokeWeight: 5,
      strokeColor: '#FF0000',
      strokeOpacity: 0.7
    });

    document.getElementById('expectedDuration').value = Math.round(route.summary.duration/60);
    document.getElementById('estimatedCost').value = route.summary.fare.taxi;
  }
</script>

</body>
</html>